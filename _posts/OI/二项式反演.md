# 主要思想

对于一个要计数的 $g_i$，我们去考虑 $f_n = \sum_{i=0}^n \binom n i g_i$ 能不能快速求，若可以，则可以 $g_n = \sum_{i=0}^n (-1)^{n-i} \binom n i f_i$ 反推回来。

# 例：错排列

设长为 $i$ 的错排列有 $d_i$ 个。

直接计数困难，构造：

$$f_n = \sum_{i=0}^n \binom n i d_i$$

考虑组合意义，我们发现 $\binom n i d_i$ 就是 $i$ 个位置错误、 $n-i$ 个位置正确、长度为 $n$ 的排列的个数。求和得到总排列个数 $f_n = n!$。

反推：

$$d_n = \sum_{i=0}^n (-1)^{n-i} \binom n i f_i = \sum_{i=0}^n (-1)^{n-i} \binom n i i!$$

可以进一步化简为

$$n! \sum_{k=0}^n \frac {(-1)^k} {k!}$$

# 例：[P10596 BZOJ2839 集合计数](https://www.luogu.com.cn/problem/P10596)

> 一个有 $N$ 个元素的集合有 $2^N$ 个不同子集（包含空集），现在要在这 $2^N$ 个集合中取出若干集合（至少一个），使得它们的交集的元素个数为 $K$，求取法的方案数，答案模 $10^9+7$。

设 $f_i$ 表示交集元素个数**恰好**是 $i$ 的方案数，答案即为 $f_K$。

直接计数困难，构造：

$$g_n = \sum_{i=n}^N \binom i n f_i$$

我们发现 $g_n$ 的组合意义为交集大小**至少**为 $n$ 的方案数，很容易算出

$$g_n = \binom N n (2^{2^{N-n}} - 1)$$

二项式反演回去：

$$\begin{aligned}
    f_n &= \sum_{i=n}^N (-1)^{i-n} \binom i n g_i \\
    &= \sum_{i=n}^N (-1)^{i-n} \binom i n \binom N i (2^{2^{N-i}} - 1) \\
\end{aligned}$$

# 二项式反演推导

可以用指数生成函数 EGF 推导，优雅且自然：

$$\begin{aligned}
    f_n &= \sum_{i=0}^n \binom n i g_i \\
    \frac {f_n} {n!} &= \sum_{i=0}^n \frac{g_i} {i!} \frac 1 {(n-i)!} \\
    \hat F(x) &= \hat G(x) \times e^x \\
    \hat G(x) &= \hat F(x) \times e^{-x} \\
    \frac {g_n} {n!} &= \sum_{i=0}^n \frac{f_i} {i!} \frac {(-1)^{n-i}} {(n-i)!} \\
    g_n &= \sum_{i=0}^n (-1)^{n-i} \binom n i f_i \\
\end{aligned}$$

# 后缀二项式反演

这是前缀的反演，那么后缀的呢？我们可以构造“倒指数生成函数”（名字我乱起的）：

$$\begin{aligned}
    f_n &= \sum_{i=n}^\infty \binom i n g_i \\
    n! f_n &= \sum_{i=n}^\infty i! g_i \times \frac 1 {(n-i)!} \\
\end{aligned}$$

构造 $F(x) := \sum_{i=0}^\infty i! f_i x^i$，$G(x)$ 同理。

构造 $H(x) := \sum_{i=0}^\infty \frac 1 {i!} x^{-i} = e^{\frac 1 x}$。

$$\begin{aligned}
    G(x) &= \frac 1 {H(x)} F(x) = e^{-\frac 1 x} F(x) \\
    n! g_n &= \sum_{i=n}^\infty i! f_i \times \frac {(-1)^{n-i}} {(n-i)!} \\
    g_n &= \sum_{i=n}^\infty (-1)^{i-n} \binom i n f_i \\
\end{aligned}$$

其实差卷积应该都可以这样构造。