我们研究 $k$ 维的标准正态分布。

我们从这个分布中取一个值 $\vec{x}$，注意到正态分布有着**各向同性**的性质，因此我们想研究 $\lVert \vec{x} \rVert$。更确切地说，我们想研究 $\lVert \vec{x} \rVert^2$ 的 PDF（这个值可以直接表示为坐标平方和而不用开根号，肯定比直接算 $\lVert \vec{x} \rVert$ 要更好算）。

这个概率分布记作 $\chi^2(k)$，称为**卡方分布**（“卡”为 $\chi$ 的音译）。维数 $k$ 被称为**自由度**（degree of freedom），也记作 $df$。

# 计算

## $\chi^2(1)$ 的计算

令 $f$ 为 $\chi^2(1)$ 的 PDF，$f_N$ 为标准正态分布 $\mathcal N(0,1)$ 的 PDF。

考虑从 CDF 的角度考虑，然后求导得到 PDF 表达式。

令 $\varphi(x) = \int_0^x f_N(t) dt$，注意 $\varphi' = f_N$。

$$\int_0^x f(t) dt = \int_{- \sqrt x}^{\sqrt x} f_N(t) dt = 2 \varphi(\sqrt x)$$

两侧同时求导：

$$f(x) = \frac 1 {2 \sqrt x} \times 2 f_N(\sqrt x) = \frac 1 {\sqrt x} f_N(\sqrt x)$$

最终得到：

$$f(x) = \frac 1 {\sqrt {2 \pi x}} e^{- \frac x 2}$$

## $\chi^2(k)$ 的计算

有一种比较直接的计算方法是把 $k$ 个 $\chi^2(1)$ 卷起来。但是当中涉及到的积分连乘在缺乏数学手段时无法处理（是 Beta 函数，一堆 Beta 函数的连乘在化为 Gamma 函数之后可以抵消）。

而且这么做并不优雅，因为我们忽略了正态分布**各向同性**的本质。

考虑几何意义的本质，我们本质是在算一个**球壳的质量**，这可以通过**球体质量**对半径求导得到（本质上还是刚才的 CDF 求导得到 PDF）。

写出正态分布的 PDF：

$$f_N(\vec{x}) = \frac 1 {(2 \pi)^{\frac k 2}} \exp (- \frac 1 2 \lVert x \rVert^2)$$

套上去，$F$ 是卡方分布的 CDF：

TODO: 清晰化此处推导。$d\Omega_{k-1}$ 是 $k$ 维球的球面的微小面积元，$C_0, C_1, C_2, C$ 是只与 $k$ 有关的常数。

$$\begin{aligned}
    F(x) &= \frac 1 {(2 \pi)^{\frac k 2}} \int_{\lVert \vec{r} \rVert \le \sqrt x} \exp(- \frac 1 2 \lVert \vec{r} \rVert^2) dV \\
    &= C_0 \int_0^{\sqrt x} \exp(- \frac 1 2 r^2) r^{k-1} dr d\Omega_{k-1} \\
    &= C_1 \int_0^{\sqrt x} \exp(- \frac 1 2 r^2) r^{k-1} dr \\
    & ^* u := \frac {r^2} 2, du = 2 r dr \\
    &= C_2 \int_0^{\frac x 2} e^{-u} r^{k-2} du \\
    &= C_2 \int_0^{\frac x 2} e^{-u} (2u)^{\frac k 2 - 1} du \\
    &= C \int_0^{\frac x 2} e^{-u} u^{\frac k 2 - 1} du \\
\end{aligned}$$

因为 $F$ 是一个 CDF，$F(\infty) = 1$：

$$\begin{aligned}
    F(\infty) &= C \int_0^\infty e^{-u} u^{\frac k 2 - 1} du \\
    & ^* \Gamma(x) := \int_0^\infty e^{-u} u^{x - 1} du \\
    &= C \Gamma(\frac k 2) \\
\end{aligned}$$

因此 $C = \frac 1 {\Gamma(\frac k 2)}$。

$$F(x) = \frac 1 {\Gamma(\frac k 2)} \int_0^{\frac x 2} e^{-u} u^{\frac k 2 - 1} du$$

求导可得：

$$f(x) = \frac 1 {2^{\frac k 2} \Gamma(\frac k 2)} x^{\frac k 2 - 1} e^{- \frac x 2}$$

定义域 $x > 0$。

### $\Gamma(\frac k 2)$ 怎么算？

对于 $k$ 是正整数的情况，我们可以显式写出公式。

Case 1：$k$ 是偶数，

$$\Gamma\left(\frac k 2 \right) = \left(\frac k 2 - 1 \right)!$$

Case 2：$k$ 是奇数，

$$\Gamma\left(\frac k 2 \right) = \frac {(k-2)!!} {2^{\frac {k-1} 2}} \sqrt \pi$$

# 卡方检验（拟合优度）

> （书 例题 8.1）
>
> 已知有一帮人（共 $90$ 人）的生日分布如下：
>
> | 生日 | 1-3 月 | 4-6 月 | 7-9 月 | 10-12 月 |
> | :-: | :-: | :-: | :-: | :-: |
> | 人数 | $34$ | $24$ | $13$ | $19$ |
>
> - 每个人的生日互相独立。
> - 认为样本数量（$n = 90$）够大，可以使用 $n \to \infty$ 的方法进行检验。
> - 认为每个类别的期望频数（$E_i = \frac {90} 4$）够大，可以使用 $E_i \to \infty$ 的方法进行检验。
>
> 支持或反对：这些人的生日符合均匀分布。（显著性水平 $\alpha = 0.05$）

## 卡方检验

TODO:

以每一维的期望值组成向量作为坐标系原点，将观测值向量标准化后看离原点的距离，并查看其落在卡方分布中的位置。

观察每一维的分布。假设每一次取样都是一次 Bernoulli 实验，那么 $n$ 次取样得到一个二项分布。

毫无疑问的是其期望为 $E_i$，现在我们想看标准差。在 $n \to \infty$ 且期望值固定时，**二项分布趋于 Poisson 分布**，而恰好 **Poisson 分布的方差等于其期望**，因此标准差为 $\sqrt {E_i}$。标准化得：

$$z_i = \frac {O_i - E_i} {\sqrt {E_i}}$$

每一维平方后加起来，得到标准化后的观测值向量距离原点距离的平方，记为 $\chi^2$：

$$\chi^2 = \sum z_i^2 = \sum \frac {(O_i - E_i)^2} {E_i}$$

与此同时，对于每一维，根据 CLT 当 $E_i \to \infty$ 时**泊松分布趋于正态分布**。因此 $z_i$ 近似服从正态分布，$\chi^2$ 近似服从卡方分布。计算 $1$ 减 $\chi^2$ 处的卡方 CDF 值即可得到 $p$ 值。

## 解题

回到题目，计算出 $\chi^2 = \frac {158} {15} \approx 10.53$。接下来我们尝试计算 $p$ 值：在生日均匀分布的前提下，有多大概率取到 $10.53$ 以上的 $\chi^2$ 值。

这里有一个重要的问题：我们应该选取几维的卡方分布？很容易觉得我们应该用 $\chi^2(4)$，但实际上并非如此。

当样本大小固定（题目中的 $90$ 人）时，我们的样本**落在一个 $3$ 维空间中**，因此应该选取 $\chi^2(3)$。

> 为什么？
>
> 可以这样理解：设那 $4$ 个随机变量为 $x_1, \cdots, x_4$，则满足限制 $x_1 + x_2 + x_3 + x_4 = 90$。$x_1, x_2, x_3$ 可以乱动；$x_4 = 90 - x_1 - x_2 - x_3$ 被限制。因此只有三个能动的变量，是 $3$ 维空间。
>
> 也可以这样理解：
>
> $$\begin{bmatrix}
>     1 & 1 & 1 & 1 \\
> \end{bmatrix} \begin{bmatrix}
>     x_1 \\ x_2 \\ x_3 \\ x_4
> \end{bmatrix} = [90]$$
>
> **解空间的维数即为自由度**。令系数矩阵为 $A$，$\text{rank}(A) = 1$。令 $N(A)$ 为 $A$ 的 null space，$\dim N(A) = 4 - \text{rank}(A) = 3$。
>
> 一个做题常用的结论是：这种“不重不漏分 $k$ 类”的问题，自由度 $df = k-1$。

$\chi^2(3)$ 的 PDF 为 $\frac 1 {\sqrt {2 \pi}} x^{\frac 1 2} e^{- \frac x 2}$，积分：

$$p = \int_{10.53}^\infty \frac 1 {\sqrt {2 \pi}} x^{\frac 1 2} e^{- \frac x 2} \approx 0.015 < \alpha$$

拒绝原假设，即反对题目给出的命题。